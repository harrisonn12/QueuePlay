global
    log stdout format raw local0 info
    maxconn 4096
    
defaults
    log global
    mode http
    option httplog
    option dontlognull
    option log-health-checks
    retries 2
    timeout connect 5s
    timeout client 1h      # Long timeout for persistent connections
    timeout server 1h      # Long timeout for persistent connections
    timeout tunnel 1h      # WebSocket tunnel timeout
    timeout check 5s

# HAProxy stats for WebSocket LB
stats enable
stats uri /websocket-stats
stats realm WebSocket\ Load\ Balancer
stats auth admin:websocket123

# WebSocket backend with sticky sessions
backend websocket_backend
    mode http
    balance source         # Source IP hash for sticky sessions
    hash-type consistent   # Consistent hashing for better distribution
    option httpchk GET /health
    
    # WebSocket servers with health checks on dedicated health ports
    server ws1 backend-websocket-1:6789 check port 6790 inter 10s fall 3 rise 2 weight 100
    server ws2 backend-websocket-2:6789 check port 6790 inter 10s fall 3 rise 2 weight 100
    
    # WebSocket-specific optimizations
    option http-server-close
    option http-pretend-keepalive
    
    # Persistent connection settings
    timeout tunnel 1h

# WebSocket frontend with upgrade detection
frontend websocket_listener
    bind *:6789
    
    # Frontend-specific timeouts
    timeout client-fin 10s
    
    # WebSocket upgrade detection
    acl is_websocket hdr(Connection) -i upgrade
    acl is_websocket_upgrade hdr(Upgrade) -i websocket
    
    # Log WebSocket connections
    capture request header Upgrade len 10
    capture request header Connection len 10
    
    default_backend websocket_backend 
